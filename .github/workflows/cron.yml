name: Support_Matrix_Execution

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: read

jobs:
  java:
    uses: ./.github/workflows/java.yml
    secrets:
      APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
  ruby:
    uses: ./.github/workflows/ruby.yml
    secrets:
      APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
  python:
    uses: ./.github/workflows/python.yml
    secrets:
      APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
  dotnet:
    uses: ./.github/workflows/dotnet.yml
    secrets:
      APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
  js_playwright:
    uses: ./.github/workflows/js_playwright.yml
    secrets:
      APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
  js_cypress:
    uses: ./.github/workflows/js_cypress.yml
    secrets:
      APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
  js_cypress_v9-:
    uses: ./.github/workflows/js_cypress_v9.yml
    secrets:
      APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
  js_testcafe:
    uses: ./.github/workflows/js_testcafe.yml
    secrets:
      APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
  js_storybook:
    uses: ./.github/workflows/js_storybook.yml
    secrets:
      APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
  js_selenium:
    uses: ./.github/workflows/js_selenium.yml
    secrets:
      APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
  js_nightwatch:
    uses: ./.github/workflows/js_nightwatch.yml
    secrets:
      APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
  js_protractor:
    uses: ./.github/workflows/js_protractor.yml
    secrets:
      APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
  js_puppeteer:
    uses: ./.github/workflows/js_puppeteer.yml
    secrets:
      APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
  js_webdriverio:
    uses: ./.github/workflows/js_webdriverio.yml
    secrets:
      APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
  js_webdriverio4:
    uses: ./.github/workflows/js_webdriverio4.yml
    secrets:
      APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
  js_webdriverio5:
    uses: ./.github/workflows/js_webdriverio5.yml
    secrets:
      APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
  appium:
    uses: ./.github/workflows/appium.yml
    secrets:
      APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
      SAUCE_USERNAME: ${{secrets.SAUCE_USERNAME}}
      SAUCE_ACCESS_KEY: ${{secrets.SAUCE_ACCESS_KEY}}
  report_generation:
    if: always()
    needs: [ java,
             ruby,
             python,
             dotnet,
             js_selenium,
             js_playwright,
             js_webdriverio,
             js_webdriverio4,
             js_webdriverio5,
             js_nightwatch,
             js_protractor,
             js_puppeteer,
             js_cypress,
             js_cypress_v9-,
             js_testcafe,
             js_storybook,
             appium
          ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Report generation
        uses: ./.github/actions/report
        with:
          token: ${{secrets.PAT}}
          run_id: ${{github.run_id}}
      - name: Check files
        run: |
          pwd
          sleep 20
          ls
      - name: Upload report as artifact
        uses: actions/upload-artifact@v3
        with:
          name: report
          path: report.html
  email_notification_fail:
    if: failure()
    needs: report_generation
    runs-on: ubuntu-latest
    steps:
      - run: echo Reporting a failure
      - name: Download report as artifact
        uses: actions/download-artifact@v3
        with:
          name: report
      - name: Send mail
        if: github.run_attempt > 1
        uses: dawidd6/action-send-mail@v3
        with:
            server_address: smtp.gmail.com
            server_port: 465
            username: ${{ secrets.EMAIL_USERNAME }}
            password: ${{ secrets.EMAIL_PASSWORD }}
            subject: SUPPORT MATRIX FAILURE
            body: Failed Support Matrix Run Workflow ${{ github.workflow }} of ${{ github.repository }}. See attachments for the report to the results
            html_body: Failed Support Matrix Run Workflow ${{ github.workflow }} of ${{ github.repository }} <br>
                       See attachments for the report to the results
            attachments: report.html
            to: yarden.ingber@applitools.com, tranduil15@gmail.com
            from: Artem
  email_notification_success:
    needs: report_generation
    runs-on: ubuntu-latest
    steps:
      - run: echo Reporting a failure
      - name: Download report as artifact
        uses: actions/download-artifact@v3
        with:
          name: report
      - name: Send mail
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: SUPPORT MATRIX SUCCESS
          body: Success Support Matrix Run Workflow ${{ github.workflow }} of ${{ github.repository }}. See attachments for the report to the results
          html_body: Success Support Matrix Run Workflow ${{ github.workflow }} of ${{ github.repository }} <br>
            See attachments for the report to the results
          attachments: report.html
          to: yarden.ingber@applitools.com, tranduil15@gmail.com
          from: Artem
  rerun:
    if: failure()
    runs-on: ubuntu-latest
    needs: [report_generation, email_notification_fail]
    steps:
      - name: rerun
        if: github.run_attempt == 1
        run: curl -X POST -H "Accept:application/vnd.github+json" -H "Content-Type:application/json" -s -u "admin:${{ secrets.PAT }}" https://api.github.com/repos/${{ github.repository }}/actions/workflows/rerun_failed.yml/dispatches -d '{"ref":"${{github.ref}}", "inputs":{"run_id":"${{github.run_id}}"}}'
